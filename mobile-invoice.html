<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Invoice Generator - Mobile</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f5f5;
            padding-bottom: 80px;
        }
        
        .header {
            background: #fff;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 24px;
            color: #333;
            font-weight: 300;
        }
        
        .invoice-number {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .container {
            max-width: 100%;
            padding: 20px;
        }
        
        .section {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: #fff;
            -webkit-appearance: none;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .required {
            color: #dc3545;
        }
        
        .service-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
        }
        
        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .service-title {
            font-weight: 600;
            color: #333;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .add-service-btn {
            width: 100%;
            padding: 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            margin-top: 10px;
        }
        
        .amount-input {
            font-size: 18px;
            font-weight: 600;
        }
        
        .total-section {
            background: #fff;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .total-label {
            font-size: 18px;
            color: #333;
        }
        
        .total-amount {
            font-size: 24px;
            font-weight: 600;
            color: #28a745;
        }
        
        .submit-btn {
            width: 100%;
            padding: 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
        }
        
        .submit-btn:disabled {
            background: #6c757d;
            opacity: 0.7;
        }
        
        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            text-align: center;
            display: none;
        }
        
        .status-message.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }
        
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }
        
        .desktop-link {
            text-align: center;
            margin-top: 20px;
            font-size: 12px;
        }
        
        .desktop-link a {
            color: #007bff;
            text-decoration: none;
        }
        
        .row {
            display: flex;
            gap: 10px;
        }
        
        .col-half {
            flex: 1;
        }
        
        .hourly-fields {
            display: none;
        }
        
        .hourly-fields.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Invoice Generator</h1>
        <div class="invoice-number">Invoice #: <span id="invoice-number">-</span></div>
    </div>

    <div class="container">
        <!-- Provider Information -->
        <div class="section">
            <h2 class="section-title">Provider Information</h2>
            
            <div class="row">
                <div class="col-half">
                    <div class="form-group">
                        <label>First Name <span class="required">*</span></label>
                        <input type="text" id="provider-first-name" required>
                    </div>
                </div>
                <div class="col-half">
                    <div class="form-group">
                        <label>Last Name <span class="required">*</span></label>
                        <input type="text" id="provider-last-name" required>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Email <span class="required">*</span></label>
                <input type="email" id="provider-email" required>
            </div>
            
            <div class="form-group">
                <label>Street Address <span class="required">*</span></label>
                <input type="text" id="provider-street" required>
            </div>
            
            <div class="row">
                <div class="col-half">
                    <div class="form-group">
                        <label>City <span class="required">*</span></label>
                        <input type="text" id="provider-city" required>
                    </div>
                </div>
                <div class="col-half">
                    <div class="form-group">
                        <label>State <span class="required">*</span></label>
                        <input type="text" id="provider-state" maxlength="2" placeholder="KS" required>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label>ZIP Code <span class="required">*</span></label>
                <input type="text" id="provider-zip" pattern="[0-9]{5}" maxlength="5" required>
            </div>
        </div>

        <!-- Invoice Details -->
        <div class="section">
            <h2 class="section-title">Invoice Details</h2>
            
            <div class="form-group">
                <label>Invoice Date <span class="required">*</span></label>
                <input type="date" id="invoice-date" required>
            </div>
            
            <div class="form-group">
                <label>Claimant Name <span class="required">*</span></label>
                <input type="text" id="claimant-name" placeholder="John Smith" required>
            </div>
            
            <div class="form-group">
                <label>Law Firm <span class="required">*</span></label>
                <input type="text" id="law-firm" placeholder="Smith & Associates" required>
            </div>
            
            <div class="form-group">
                <label>Payment Terms (Days)</label>
                <input type="number" id="payment-terms" value="30">
            </div>
        </div>

        <!-- Services -->
        <div class="section">
            <h2 class="section-title">Services</h2>
            
            <div id="services-container">
                <!-- Service cards will be added here -->
            </div>
            
            <button class="add-service-btn" onclick="addService()">+ Add Service</button>
        </div>

        <div class="desktop-link">
            <a href="./desktop-invoice.html">Switch to Desktop Version</a>
            |
            <a href="./index.html">Return to Home</a>
        </div>
    </div>

    <!-- Fixed Total Section -->
    <div class="total-section">
        <div class="total-row">
            <span class="total-label">Total:</span>
            <span class="total-amount">$<span id="total">0.00</span></span>
        </div>
        <button class="submit-btn" onclick="submitInvoice()">Submit Invoice</button>
        <div id="status-message" class="status-message"></div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyGfa00U2ewclnceG5GYcPrbRUJZGtTyYco3n74giohd3YFplggxkF9QLhXBy_MfcbNEQ/exec';
        let serviceCount = 0;

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('invoice-date').value = today;
            
            // Add first service
            addService();
            
            // Add event listeners for invoice number generation
            document.getElementById('provider-first-name').addEventListener('input', generateInvoiceNumber);
            document.getElementById('provider-last-name').addEventListener('input', generateInvoiceNumber);
            document.getElementById('claimant-name').addEventListener('input', generateInvoiceNumber);
        });

        function addService() {
            serviceCount++;
            const container = document.getElementById('services-container');
            
            const serviceCard = document.createElement('div');
            serviceCard.className = 'service-card';
            serviceCard.id = `service-${serviceCount}`;
            
            serviceCard.innerHTML = `
                <div class="service-header">
                    <span class="service-title">Service ${serviceCount}</span>
                    ${serviceCount > 1 ? `<button class="delete-btn" onclick="removeService(${serviceCount})">Remove</button>` : ''}
                </div>
                
                <div class="form-group">
                    <label>Service Date <span class="required">*</span></label>
                    <input type="date" class="service-date" required>
                </div>
                
                <div class="form-group">
                    <label>Service Type <span class="required">*</span></label>
                    <select class="service-type" onchange="updateServiceType(this, ${serviceCount})" required>
                        <option value="">-- Select Service --</option>
                        <option value="ime-flat">IME + Report</option>
                        <option value="supplemental-flat">Supplemental Report</option>
                        <option value="records-hourly">Records Review (Hourly)</option>
                        <option value="deposition-hourly">Deposition (Hourly)</option>
                        <option value="conference-hourly">Conference/Meeting (Hourly)</option>
                        <option value="addendum-hourly">Addendum (Hourly)</option>
                        <option value="other-flat">Other Service</option>
                    </select>
                </div>
                
                <div class="hourly-fields" id="hourly-${serviceCount}">
                    <div class="row">
                        <div class="col-half">
                            <div class="form-group">
                                <label>Hours</label>
                                <input type="number" step="0.25" class="hours" onchange="calculateHourly(${serviceCount})">
                            </div>
                        </div>
                        <div class="col-half">
                            <div class="form-group">
                                <label>Rate/Hour</label>
                                <input type="number" step="0.01" class="rate" onchange="calculateHourly(${serviceCount})">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Amount <span class="required">*</span></label>
                    <input type="number" step="0.01" class="amount amount-input" onchange="calculateTotal()" required>
                </div>
            `;
            
            container.appendChild(serviceCard);
        }

        function removeService(id) {
            const element = document.getElementById(`service-${id}`);
            if (element) {
                element.remove();
                calculateTotal();
            }
        }

        function updateServiceType(select, serviceId) {
            const hourlyFields = document.getElementById(`hourly-${serviceId}`);
            const serviceCard = document.getElementById(`service-${serviceId}`);
            const amountField = serviceCard.querySelector('.amount');
            
            if (select.value.includes('hourly')) {
                hourlyFields.classList.add('show');
                amountField.setAttribute('readonly', true);
            } else {
                hourlyFields.classList.remove('show');
                amountField.removeAttribute('readonly');
            }
        }

        function calculateHourly(serviceId) {
            const serviceCard = document.getElementById(`service-${serviceId}`);
            const hours = parseFloat(serviceCard.querySelector('.hours').value) || 0;
            const rate = parseFloat(serviceCard.querySelector('.rate').value) || 0;
            const amountField = serviceCard.querySelector('.amount');
            
            if (hours > 0 && rate > 0) {
                amountField.value = (hours * rate).toFixed(2);
                calculateTotal();
            }
        }

        function calculateTotal() {
            let total = 0;
            const amounts = document.querySelectorAll('.amount');
            amounts.forEach(field => {
                total += parseFloat(field.value) || 0;
            });
            document.getElementById('total').textContent = total.toFixed(2);
        }

        function generateInvoiceNumber() {
            const firstName = document.getElementById('provider-first-name').value;
            const lastName = document.getElementById('provider-last-name').value;
            const claimantName = document.getElementById('claimant-name').value;
            
            if (lastName && claimantName) {
                const date = new Date();
                const dateStr = date.toISOString().split('T')[0].replace(/-/g, '');
                const lastNameClean = lastName.replace(/[^a-zA-Z]/g, '').toUpperCase();
                const claimantPart = claimantName.split(' ').pop().replace(/[^a-zA-Z]/g, '').toUpperCase();
                
                document.getElementById('invoice-number').textContent = 
                    `INV-${dateStr}-${lastNameClean}-${claimantPart}`;
            }
        }

        function validateForm() {
            const firstName = document.getElementById('provider-first-name').value.trim();
            const lastName = document.getElementById('provider-last-name').value.trim();
            const email = document.getElementById('provider-email').value.trim();
            const street = document.getElementById('provider-street').value.trim();
            const city = document.getElementById('provider-city').value.trim();
            const state = document.getElementById('provider-state').value.trim();
            const zip = document.getElementById('provider-zip').value.trim();
            const claimantName = document.getElementById('claimant-name').value.trim();
            const lawFirm = document.getElementById('law-firm').value.trim();
            
            const errors = [];
            
            if (!firstName) errors.push('First Name');
            if (!lastName) errors.push('Last Name');
            if (!email) errors.push('Email');
            if (!street) errors.push('Street Address');
            if (!city) errors.push('City');
            if (!state) errors.push('State');
            if (!zip) errors.push('ZIP Code');
            if (!claimantName) errors.push('Claimant Name');
            if (!lawFirm) errors.push('Law Firm');
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (email && !emailRegex.test(email)) {
                errors.push('Valid email address');
            }
            
            // Check services
            const services = document.querySelectorAll('.service-card');
            let hasValidService = false;
            services.forEach(card => {
                const serviceType = card.querySelector('.service-type').value;
                if (serviceType) hasValidService = true;
            });
            
            if (!hasValidService) {
                errors.push('At least one service');
            }
            
            return errors;
        }

        function collectData() {
            const services = [];
            const serviceCards = document.querySelectorAll('.service-card');
            
            serviceCards.forEach(card => {
                const serviceType = card.querySelector('.service-type');
                const selectedOption = serviceType.options[serviceType.selectedIndex];
                
                services.push({
                    date: card.querySelector('.service-date').value,
                    serviceType: selectedOption.text,
                    hours: card.querySelector('.hours').value || '-',
                    rate: card.querySelector('.rate').value || '-',
                    amount: card.querySelector('.amount').value
                });
            });
            
            return {
                invoiceNumber: document.getElementById('invoice-number').textContent,
                invoiceDate: document.getElementById('invoice-date').value,
                providerFirstName: document.getElementById('provider-first-name').value,
                providerLastName: document.getElementById('provider-last-name').value,
                providerAddressStreet: document.getElementById('provider-street').value,
                providerAddressCity: document.getElementById('provider-city').value,
                providerAddressState: document.getElementById('provider-state').value,
                providerAddressZip: document.getElementById('provider-zip').value,
                providerEmail: document.getElementById('provider-email').value,
                claimantName: document.getElementById('claimant-name').value,
                lawFirm: document.getElementById('law-firm').value,
                services: services,
                subtotal: document.getElementById('total').textContent,
                total: document.getElementById('total').textContent,
                paymentTerms: document.getElementById('payment-terms').value
            };
        }

        function submitInvoice() {
            const statusMessage = document.getElementById('status-message');
            const submitBtn = document.querySelector('.submit-btn');
            
            // Validate
            const errors = validateForm();
            if (errors.length > 0) {
                statusMessage.className = 'status-message error';
                statusMessage.textContent = 'Missing: ' + errors.join(', ');
                return;
            }
            
            // Collect and submit
            const data = collectData();
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            statusMessage.className = 'status-message';
            statusMessage.style.display = 'none';
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(() => {
                statusMessage.className = 'status-message success';
                statusMessage.textContent = 'Invoice submitted successfully!';
                submitBtn.textContent = 'Submit Invoice';
                submitBtn.disabled = false;
                
                setTimeout(() => {
                    if (confirm('Create another invoice?')) {
                        location.reload();
                    }
                }, 2000);
            })
            .catch(error => {
                statusMessage.className = 'status-message error';
                statusMessage.textContent = 'Error submitting. Please try again.';
                submitBtn.textContent = 'Submit Invoice';
                submitBtn.disabled = false;
            });
        }
    </script>
</body>
</html>
